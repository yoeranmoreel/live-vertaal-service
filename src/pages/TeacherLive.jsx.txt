// src/pages/TeacherLive.jsx
import React, { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { sessionsApi, messagesApi, translationApi } from "@/api/sheetsClient";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { motion, AnimatePresence } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Mic, MicOff, StopCircle, Loader2, AlertCircle, Users, Languages, QrCode, Download, FileText } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";
import QRCode from "qrcode";

export default function TeacherLive() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session');

  const [listening, setListening] = useState(false);
  const [interimTranscript, setInterimTranscript] = useState("");
  const [error, setError] = useState(null);
  const [micPermission, setMicPermission] = useState(null);
  const [transcriptStarted, setTranscriptStarted] = useState(false);
  const [qrCodeUrl, setQrCodeUrl] = useState("");
  const recognitionRef = useRef(null);

  // Check microphone permission
  useEffect(() => {
    const checkMicPermission = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        setMicPermission('granted');
      } catch (err) {
        setMicPermission('denied');
        setError("Microfoon toegang geweigerd. Klik op het slotje in de adresbalk en sta microfoon toe.");
      }
    };
    
    checkMicPermission();
  }, []);

  const { data: session, isLoading: sessionLoading } = useQuery({
    queryKey: ['session', sessionId],
    queryFn: async () => {
      const sess = await sessionsApi.getById(sessionId);
      if (!sess) throw new Error('Sessie niet gevonden');
      return sess;
    },
    enabled: !!sessionId,
  });

  const { data: messages, isLoading: messagesLoading } = useQuery({
    queryKey: ['messages', sessionId],
    queryFn: () => messagesApi.getBySession(sessionId),
    enabled: !!sessionId,
    refetchInterval: 3000,
    initialData: [],
  });

  // Generate QR code
  useEffect(() => {
    if (session) {
      const joinUrl = `${window.location.origin}${createPageUrl("ParentView")}?session=${session.session_code}`;
      QRCode.toDataURL(joinUrl, { width: 200, margin: 2 })
        .then(url => setQrCodeUrl(url))
        .catch(err => console.error('QR code generation failed:', err));
    }
  }, [session]);

  const createMessageMutation = useMutation({
    mutationFn: async (originalText) => {
      return await messagesApi.create({
        session_id: sessionId,
        original_text: originalText
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['messages', sessionId] });
    },
  });

  const endSessionMutation = useMutation({
    mutationFn: async () => {
      // Download PDF eerst
      await handleDownloadTeacherPdf();
      
      // Dan sessie beÃ«indigen
      return await sessionsApi.update(sessionId, {
        status: 'ended',
        ended_date: new Date().toISOString()
      });
    },
    onSuccess: () => {
      navigate(createPageUrl("TeacherDashboard"));
    },
  });

  // Speech recognition setup
  useEffect(() => {
    if (!sessionId || !transcriptStarted) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      setError("Spraakherkenning wordt niet ondersteund in deze browser. Gebruik Chrome, Edge of Safari.");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'nl-NL';
    recognition.interimResults = true;
    recognition.continuous = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      setListening(true);
      setError(null);
    };

    recognition.onresult = (event) => {
      let interim = "";
      let final = "";
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          final += transcript + " ";
        } else {
          interim += transcript;
        }
      }
      
      setInterimTranscript(interim);
      
      if (final.trim()) {
        createMessageMutation.mutate(final.trim());
        setInterimTranscript("");
      }
    };

    recognition.onerror = (event) => {
      if (event.error === 'not-allowed') {
        setError("Microfoon toegang geweigerd. Klik op het slotje in de adresbalk en sta microfoon toe.");
        setMicPermission('denied');
      } else if (event.error === 'no-speech') {
        // Ignore, continue listening
      } else if (event.error === 'aborted') {
        // Restart
      } else {
        setError("Spraakherkenning fout: " + event.error);
      }
    };

    recognition.onend = () => {
      if (transcriptStarted && listening) {
        try {
          recognition.start();
        } catch (e) {
          setTimeout(() => {
            try {
              recognition.start();
            } catch (err) {
              console.error("Failed to restart:", err);
            }
          }, 100);
        }
      } else {
        setListening(false);
      }
    };

    recognitionRef.current = recognition;

    try {
      recognition.start();
    } catch (e) {
      console.error("Error starting recognition:", e);
    }

    return () => {
      try {
        recognition.stop();
      } catch (e) {}
    };
  }, [sessionId, transcriptStarted]);

  const handleStartTranscript = () => {
    setTranscriptStarted(true);
  };

  const handleStopTranscript = () => {
    setTranscriptStarted(false);
    if (recognitionRef.current) {
      try {
        recognitionRef.current.stop();
      } catch (e) {}
    }
  };

  const handleEndSession = async () => {
    if (confirm('Weet u zeker dat u deze sessie wilt beÃ«indigen? U ontvangt automatisch een PDF transcript.')) {
      handleStopTranscript();
      await endSessionMutation.mutateAsync();
    }
  };

  const handleDownloadTeacherPdf = async () => {
    if (!session || !messages || messages.length === 0) return;
    
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Leerkracht Transcript - ${session.session_code}</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 40px auto; 
            padding: 20px;
          }
          h1 { color: #4F46E5; border-bottom: 2px solid #4F46E5; padding-bottom: 10px; }
          .meta { color: #666; margin-bottom: 30px; background: #f9fafb; padding: 15px; border-radius: 8px; }
          .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
          .stat-box { background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center; }
          .stat-value { font-size: 24px; font-weight: bold; color: #4F46E5; }
          .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
          .message { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #f9fafb; 
            border-left: 4px solid #4F46E5;
            border-radius: 4px;
          }
          .timestamp { color: #999; font-size: 12px; margin-bottom: 5px; }
          .text { line-height: 1.6; }
          .footer { 
            margin-top: 40px; 
            padding-top: 20px; 
            border-top: 1px solid #ddd; 
            text-align: center; 
            color: #666; 
            font-size: 12px;
          }
          .language-breakdown { margin-bottom: 30px; }
          .language-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px; 
            background: #f9fafb; 
            margin-bottom: 5px;
            border-radius: 4px;
          }
        </style>
      </head>
      <body>
        <h1>ğŸ“ Leerkracht Transcript</h1>
        <div class="meta">
          <p><strong>Sessie:</strong> ${session.session_code}</p>
          <p><strong>Leerkracht:</strong> ${session.teacher_name}</p>
          <p><strong>Datum:</strong> ${new Date(session.created_date).toLocaleString('nl-NL')}</p>
          ${session.ended_date ? `<p><strong>BeÃ«indigd:</strong> ${new Date(session.ended_date).toLocaleString('nl-NL')}</p>` : ''}
        </div>
        
        <div class="stats">
          <div class="stat-box">
            <div class="stat-value">${session.total_participants || 0}</div>
            <div class="stat-label">Ouders aanwezig</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${messages.length}</div>
            <div class="stat-label">Berichten gesproken</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${Object.keys(session.language_stats || {}).length}</div>
            <div class="stat-label">Verschillende talen</div>
          </div>
        </div>

        ${Object.keys(session.language_stats || {}).length > 0 ? `
          <div class="language-breakdown">
            <h3>Taalverdeling</h3>
            ${Object.entries(session.language_stats).map(([lang, count]) => {
              const langNames = { 'nl': 'ğŸ‡³ğŸ‡± Nederlands', 'en': 'ğŸ‡¬ğŸ‡§ Engels', 'ar': 'ğŸ‡¸ğŸ‡¦ Arabisch', 'pl': 'ğŸ‡µğŸ‡± Pools', 'bg': 'ğŸ‡§ğŸ‡¬ Bulgaars', 'ro': 'ğŸ‡·ğŸ‡´ Roemeens', 'tr': 'ğŸ‡¹ğŸ‡· Turks', 'uk': 'ğŸ‡ºğŸ‡¦ OekraÃ¯ens' };
              return `<div class="language-item">
                <span>${langNames[lang] || lang}</span>
                <span><strong>${count}</strong> ouder${count !== 1 ? 's' : ''}</span>
              </div>`;
            }).join('')}
          </div>
        ` : ''}
        
        <h3>Gesprek Transcript (Nederlands)</h3>
        ${messages.map(msg => `
          <div class="message">
            <div class="timestamp">${new Date(msg.created_date).toLocaleTimeString('nl-NL')}</div>
            <div class="text">${msg.original_text}</div>
          </div>
        `).join('')}
        
        <div class="footer">
          <p><strong>Live Vertaal Service</strong> Â© ${new Date().getFullYear()}</p>
          <p>Ontwikkeld met â¤ï¸ voor inclusief onderwijs door Yoeran Moreel</p>
          <p style="margin-top: 10px; color: #999;">Dit transcript is automatisch gegenereerd tijdens het oudercontact</p>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 250);
  };

  if (sessionLoading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
      </div>
    );
  }

  if (!session) {
    return (
      <div className="max-w-2xl mx-auto mt-20">
        <Alert variant="destructive">
          <AlertCircle className="h-5 w-5" />
          <AlertDescription>Sessie niet gevonden</AlertDescription>
        </Alert>
      </div>
    );
  }

  const joinUrl = `${window.location.origin}${createPageUrl("ParentView")}?session=${session.session_code}`;
  const languageStats = session.language_stats || {};
  const totalParticipants = session.total_participants || 0;

  return (
    <div className="max-w-6xl mx-auto">
      <div className="grid md:grid-cols-3 gap-6">
        {/* Left Column - Controls */}
        <div className="md:col-span-1 space-y-6">
          {/* QR Code & Session Info */}
          <Card className="glass-effect border-white/50 shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                <QrCode className="w-5 h-5 text-indigo-500" />
                Sessie Info
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {qrCodeUrl && (
                <div className="bg-white p-4 rounded-xl border-2 border-indigo-100 flex items-center justify-center">
                  <img src={qrCodeUrl} alt="QR Code" className="w-48 h-48" />
                </div>
              )}
              
              <div className="text-center space-y-2">
                <p className="text-sm text-gray-600">Sessiecode:</p>
                <p className="text-3xl font-bold font-mono text-indigo-600">{session.session_code}</p>
                <p className="text-xs text-gray-500">Ouders scannen de QR of voeren de code in</p>
              </div>
            </CardContent>
          </Card>

          {/* Speech Controls */}
          <Card className="glass-effect border-white/50 shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                {listening ? <Mic className="w-5 h-5 text-emerald-500 animate-pulse" /> : <MicOff className="w-5 h-5 text-gray-400" />}
                Spraakbesturing
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {micPermission === 'denied' && (
                <Alert variant="destructive">
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription className="text-sm">
                    Microfoon toegang geweigerd. Klik op het slotje in de adresbalk.
                  </AlertDescription>
                </Alert>
              )}

              {micPermission === 'granted' && !transcriptStarted && (
                <Alert>
                  <AlertDescription className="text-sm">
                    Microfoon is klaar. Start transcript om te beginnen.
                  </AlertDescription>
                </Alert>
              )}

              {interimTranscript && (
                <div className="p-3 rounded-lg bg-blue-50 border border-blue-200">
                  <p className="text-sm text-blue-700 italic">{interimTranscript}</p>
                </div>
              )}

              <div className="space-y-2">
                {transcriptStarted ? (
                  <Button
                    onClick={handleStopTranscript}
                    variant="outline"
                    className="w-full py-6 rounded-xl border-2"
                  >
                    <MicOff className="w-5 h-5 mr-2" />
                    Stop Transcript
                  </Button>
                ) : (
                  <Button
                    onClick={handleStartTranscript}
                    disabled={micPermission !== 'granted'}
                    className="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-6 rounded-xl"
                  >
                    <Mic className="w-5 h-5 mr-2" />
                    Start Transcript
                  </Button>
                )}

                <Button
                  onClick={handleDownloadTeacherPdf}
                  disabled={!messages || messages.length === 0}
                  variant="outline"
                  className="w-full py-6 rounded-xl"
                >
                  <Download className="w-5 h-5 mr-2" />
                  Download PDF
                </Button>

                <Button
                  onClick={handleEndSession}
                  variant="destructive"
                  className="w-full py-6 rounded-xl font-semibold"
                >
                  <StopCircle className="w-5 h-5 mr-2" />
                  Sessie BeÃ«indigen
                </Button>
              </div>

              <div className="text-xs text-gray-500 text-center space-y-1">
                <p>ğŸ’¡ Tip: Spreek duidelijk en pauzeer tussen zinnen</p>
                <p>De microfoon luistert continu wanneer actief</p>
              </div>
            </CardContent>
          </Card>

          {/* Participant Stats */}
          <Card className="glass-effect border-white/50 shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                <Users className="w-5 h-5 text-purple-500" />
                Live Statistieken
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="text-center p-4 rounded-xl bg-purple-50">
                <div className="text-4xl font-bold text-purple-600">{totalParticipants}</div>
                <div className="text-sm text-purple-700 mt-1">Ouders aangesloten</div>
              </div>

              {Object.keys(languageStats).length > 0 && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <Languages className="w-4 h-4" />
                    Gekozen talen:
                  </div>
                  {Object.entries(languageStats).map(([lang, count]) => {
                    const langEmojis = { 'nl': 'ğŸ‡³ğŸ‡±', 'en': 'ğŸ‡¬ğŸ‡§', 'ar': 'ğŸ‡¸ğŸ‡¦', 'pl': 'ğŸ‡µğŸ‡±', 'bg': 'ğŸ‡§ğŸ‡¬', 'ro': 'ğŸ‡·ğŸ‡´', 'tr': 'ğŸ‡¹ğŸ‡·', 'uk': 'ğŸ‡ºğŸ‡¦' };
                    const langNames = { 'nl': 'NL', 'en': 'EN', 'ar': 'AR', 'pl': 'PL', 'bg': 'BG', 'ro': 'RO', 'tr': 'TR', 'uk': 'UK' };
                    return (
                      <div key={lang} className="flex items-center justify-between p-2 rounded-lg bg-gray-50">
                        <span className="flex items-center gap-2">
                          <span className="text-xl">{langEmojis[lang] || 'ğŸŒ'}</span>
                          <span className="text-sm font-medium">{langNames[lang] || lang}</span>
                        </span>
                        <span className="text-sm font-bold text-gray-700">{count}</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Right Column - Messages */}
        <div className="md:col-span-2">
          <Card className="glass-effect border-white/50 shadow-lg h-[calc(100vh-200px)]">
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <FileText className="w-5 h-5 text-indigo-500" />
                  Live Transcript
                </span>
                <span className="text-sm font-normal text-gray-500">
                  {messages?.length || 0} bericht{messages?.length !== 1 ? 'en' : ''}
                </span>
              </CardTitle>
            </CardHeader>
            <CardContent className="h-[calc(100%-80px)] overflow-y-auto">
              {!messages || messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                  <FileText className="w-16 h-16 mb-4" />
                  <p className="text-lg">Nog geen berichten</p>
                  <p className="text-sm">Start transcript om te beginnen</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {messages.map((msg, index) => (
                    <motion.div
                      key={msg.id}
                      initial={{ opacity: 0, x: -20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.02 }}
                      className="p-4 rounded-xl bg-white border border-gray-100 shadow-sm hover:shadow-md transition-shadow"
                    >
                      <div className="flex items-start justify-between gap-3 mb-2">
                        <p className="text-gray-900 flex-1 leading-relaxed">{msg.original_text}</p>
                        <span className="text-xs text-gray-400 whitespace-nowrap">
                          {new Date(msg.created_date).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })}
                        </span>
                      </div>
                    </motion.div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}